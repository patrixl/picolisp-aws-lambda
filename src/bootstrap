#!./pil/bin/picolisp ./pil/lib.l

(load "@lib/misc.l" "@lib/http.l")

(loop
   (let (Runtime (sys "AWS_LAMBDA_RUNTIME_API")
      Script (car (mapcar pack (split (chop (sys "_HANDLER")) ".")))
      Function (cadr (mapcar pack (split (chop (sys "_HANDLER")) ".")))
      Root (sys "LAMBDA_TASK_ROOT")
      Api (sys "AWS_LAMBDA_RUNTIME_API")
      Temp (in '(mktemp) (till "^J" T))
      Url (pack "http://" Api "/2018-06-01/runtime/invocation/next")
      Curl (make (link 'curl "--silent" "--show-error" "--location" "--dump-header" Temp
                   "-X" "GET" Url ) )
      EventData (in Curl (till NIL T))
      Headers (mapcar '((L) (mapcar '((A) (pack (clip A))) (split L ":"))) (split (chop (in Temp (till NIL T))) "^J"))
      Request (cadr (assoc "Lambda-Runtime-Aws-Request-Id" Headers)))

      (load (pack Root "/" Script ".l"))
      (setq Response (eval (append (str (pack Function)) (list EventData))))
      (prinl "Response: " Response)

      (setq Url (pack "http://" Api "/2018-06-01/runtime/invocation/" Request "/response"))
      (setq Curl (make (link 'curl "--silent" "--show-error" "--location" "-X" "POST" Url "-d" Response ) ))
      (in Curl (till NIL T))

      (call 'rm Temp) ) )

      # error handling, context info, etc????
      # https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html#runtimes-custom-build

(bye)
